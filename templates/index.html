{% extends "base.html" %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3 me-6">
        <form action="{{ url_for('scrape') }}" method="post" class="d-flex flex-grow-1">
            <input type="url" name="url" placeholder="Ссылка на учебник" required class="form-control me-2">
            <button type="submit" class="btn btn-primary">Поиск</button>
        </form>

        {% if books %}
            <button class="btn btn-success ms-3" id="exportAllBtn" title="Экспортировать все книги">
                {{ render_icon('download') }}
            </button>
        {% endif %}
    </div>

    {% if not books %}
    <div class="alert alert-info">
        Нет данных для отображения. Добавьте книги через форму поиска.
    </div>
    {% else %}

    <!-- Фильтры -->
    {% include 'filter_table.html' %}

    <table class="table table-striped table-hover" id="booksTable">
        <thead>
            <tr>
                <th scope="col">Обложка</th>
                <th scope="col">Предмет</th>
                <th scope="col">Программа</th>
                <th scope="col">Серия</th>
                <th scope="col">Название</th>
                <th scope="col">Авторы</th>
                <th scope="col">Класс</th>
                <th scope="col">Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for book in books %}
            <tr id="row-{{ book.id }}" data-subject="{{ book.subject }}" data-class="{{ book.class_from }}"
                data-program="{{ book.program }}" data-series="{{ book.series }}">
                <td>
                    {% if book.image_url %}
                    <img class="rounded image zoom-image"
                         src="{{ book.image_url }}"
                         alt="Обложка книги"
                         style="max-width: 100px; max-height: 150px;"/>
                    {% else %}
                    <span>Нет обложки/Ошибка загрузки</span>
                    {% endif %}
                </td>
                <td>
                    {{ book.subject }}
                </td>
                <td>
                    {{ book.program }}
                </td>
                <td>
                    {{ book.series }}
                </td>
                <td>
                    <a href="{{ book.url }}" target="_blank">
                        {{ book.name if book.name else 'Без названия' }}
                    </a>
                </td>
                <td>
                    {{ book.authors if book.authors else 'Авторы не указаны' }}
                </td>
                <td>
                    {{ book.class_from }}
                    {% if book.class_to and book.class_to != book.class_from %}
                       - {{ book.class_to }}
                    {% endif %}
                </td>
                <td>
                    <button class="btn btn-info view-btn" data-id="{{ book.id }}" data-bs-toggle="modal"
                            data-bs-target="#bookModal" title="Открыть все характеристики учебника">
                        {{ render_icon('eye') }}
                    </button>
                    <button class="btn btn-success export-btn" data-id="{{ book.id }}"
                            title="Экспортировать только этот учебник">
                        {{ render_icon('download') }}
                    </button>
                    <button class="btn btn-danger delete-btn" data-id="{{ book.id }}"
                            title="Удалить информацию об этом учебнике">
                        {{ render_icon('trash3') }}
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <!-- Модальное окно для просмотра и редактирования книги -->
    {% include 'modals/edit_book.html' %}

    <script>
        $(document).ready(function() {
            // Экспорт всех книг
            $('#exportAllBtn').click(function() {
                if (confirm('Экспортировать все книги в ZIP архив? Архив будет содержать CSV файл и все изображения.')) {
                    window.location.href = '/export-books';
                }
            });

            // Экспорт одной книги
            $('.export-btn').click(function() {
                const bookId = $(this).data('id');
                if (confirm('Экспортировать эту книгу в ZIP архив?')) {
                    window.location.href = '/export-book/' + bookId;
                }
            });

            // Удаление книги
            $('.delete-btn').click(function() {
                const bookId = $(this).data('id');
                if (confirm('Вы уверены, что хотите удалить эту книгу?')) {
                    $.ajax({
                        url: '/delete',
                        method: 'POST',
                        data: { book_id: bookId },
                        success: function(response) {
                            const data = JSON.parse(response);
                            if (data.success) {
                                $('#row-' + bookId).remove();
                                showAlert('Книга успешно удалена!', 'success');
                            } else {
                                showAlert('Ошибка при удалении: ' + data.error, 'danger');
                            }
                        },
                        error: function() {
                            showAlert('Ошибка при удалении', 'danger');
                        }
                    });
                }
            });

            // Функция показа уведомлений
            function showAlert(message, type) {
                const alertClass = `alert alert-${type} alert-dismissible fade show`;
                const alert = `
                    <div class="${alertClass}" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 1060;">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;

                $('body').append(alert);

                setTimeout(() => {
                    $('.alert-dismissible').alert('close');
                }, 3000);
            }
        });
    </script>

    <script src="{{ url_for('static', filename='edit-book.js') }}"></script>

{% endblock %}