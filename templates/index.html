{% extends "base.html" %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <form action="{{ url_for('scrape') }}" method="post" class="d-flex">
            <input type="url" name="url" placeholder="Ссылка на учебник" required class="form-control me-2">
            <button type="submit" class="btn btn-primary">Поиск</button>
        </form>

        {% if books %}
            <div>
                <button class="btn btn-success" id="exportAllBtn">
                    <i class="bi bi-download"></i> Экспорт всех книг
                </button>
            </div>
        {% endif %}
    </div>

    {% if not books %}
        <div class="alert alert-info">
            Нет данных для отображения. Добавьте книги через форму поиска.
        </div>
    {% else %}
        <table class="table table-hover table-dark">
            <thead>
                <tr>
                    <th scope="col">Обложка</th>
                    <th scope="col">Название</th>
                    <th scope="col">Авторы</th>
                    <th scope="col">Класс</th>
                    <th scope="col">Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for book in books %}
                <tr id="row-{{ book.id }}">
                    <th>
                        {% if book.image_url %}
                        <img class="rounded image zoom-image"
                             src="{{ book.image_url }}"
                             alt="Обложка книги"
                             style="max-width: 100px; max-height: 150px;"/>
                        {% else %}
                        <span>Нет обложки</span>
                        {% endif %}
                    </th>
                    <th>
                        <a href="{{ book.url }}" target="_blank">
                            {{ book.name if book.name else 'Без названия' }}
                        </a>
                    </th>
                    <th>
                        {{ book.authors if book.authors else 'Авторы не указаны' }}
                    </th>
                    <th>
                        {{ book.class_from }}
                        {% if book.class_to and book.class_to != book.class_from %}
                           - {{ book.class_to }}
                        {% endif %}

                    </th>
                    <th>
                        <button class="btn btn-info view-btn" data-bs-toggle="modal" data-bs-target="#bookModal" data-id="{{ book.id }}">
                            {{ render_icon('eye') }}
                        </button>
                        <button class="btn btn-success export-btn" data-id="{{ book.id }}">
                            {{ render_icon('download') }}
                        </button>
                        <button class="btn btn-danger delete-btn" data-id="{{ book.id }}">
                            {{ render_icon('trash3') }}
                        </button>
                    </th>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}

    <!-- Модальное окно для просмотра и редактирования книги -->
    {% include 'modals/edit_book.html' %}


    {% block scripts %}
        {{ super() }}
    {% endblock %}


    <script>
        $(document).ready(function() {
            // Экспорт всех книг
            $('#exportAllBtn').click(function() {
                if (confirm('Экспортировать все книги в ZIP архив? Архив будет содержать CSV файл и все изображения.')) {
                    window.location.href = '/export-books';
                }
            });

            // Экспорт одной книги
            $('.export-btn').click(function() {
                const bookId = $(this).data('id');
                if (confirm('Экспортировать эту книгу в ZIP архив?')) {
                    window.location.href = '/export-book/' + bookId;
                }
            });

            // Удаление книги
            $('.delete-btn').click(function() {
                const bookId = $(this).data('id');
                if (confirm('Вы уверены, что хотите удалить эту книгу?')) {
                    $.ajax({
                        url: '/delete',
                        method: 'POST',
                        data: { book_id: bookId },
                        success: function(response) {
                            const data = JSON.parse(response);
                            if (data.success) {
                                $('#row-' + bookId).remove();
                                showAlert('Книга успешно удалена!', 'success');
                            } else {
                                showAlert('Ошибка при удалении: ' + data.error, 'danger');
                            }
                        },
                        error: function() {
                            showAlert('Ошибка при удалении', 'danger');
                        }
                    });
                }
            });

            // Функция показа уведомлений
            function showAlert(message, type) {
                const alertClass = `alert alert-${type} alert-dismissible fade show`;
                const alert = `
                    <div class="${alertClass}" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 1060;">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;

                $('body').append(alert);

                setTimeout(() => {
                    $('.alert-dismissible').alert('close');
                }, 3000);
            }
        });
    </script>

    <script src="{{ url_for('static', filename='edit-book.js') }}"></script>

{% endblock %}